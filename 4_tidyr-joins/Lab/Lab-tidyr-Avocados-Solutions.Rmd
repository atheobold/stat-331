---
title: "Lab 4: Avocado Prices"
subtitle: "Stat 331 </br> Solutions by Dr. Theobold"
output: rmdformats::readthedown
---

__My Global Options:__

```{r global_options, include = TRUE}
knitr::opts_chunk$set(fig.width = 12,
                      fig.height = 8,
                      echo = TRUE,
                      warning = FALSE,
                      message = FALSE,
                      eval = TRUE,
                      include = TRUE)
```

---

# Introduction & Set-up

In this lab we're going to be looking at avocado prices. 

The dataset comes to us from kaggle and represents weekly retail scan data. 
It is available to download from Canvas under the name `avocado.csv`.  A
description of the data can be found [here (link).](https://www.kaggle.com/neuromusic/avocado-prices)

__0.__ Create an R Markdown file, load the data, and declare your package
dependencies. 

```{r, message = FALSE}
library(tidyverse)

avocado <- read_csv(here::here("4_tidyr-joins",
                               "Lab",
                               "avocado.csv")
                    )

```

**Note:** Your HTML file **should not** have any messages from loading in the 
data or loading in packages!

</br> 

__1.__ Briefly describe the dataset.  What information does it contain?

**Possible Response:** _These data come from weekly retail scales for 
National retail volume and prices of Hass avocados, from 2015 to
2018. There are variables measuring the date of the sale, the average price of 
a single avocado, the region of the sale, the type of avocado (organic 
or conventional), and the size of the avocado._

</br> 

__2.__ Clean the data in any way you see fit. In particular, look carefully at
the `region` variable.  Notice that the category `"LosAngeles"` is contained in
`"California"`, which is contained in `"West"`, which is contained in 
`"TotalUS"`. Think about how you want to handle this issue in your analysis.


```{r}
avocado <- avocado %>%
  # Rename the PLU variables to be sizes of avocados!
  rename(
    Size_Small = `4046`,
    Size_Large = `4225`,
    Size_XL = `4770`) %>% 
  # Filter out "TotalUS" because it is not a region or city!
  filter(region != "TotalUS")

# Make tibble with the names of the major regions 
major_regions <- tibble(region = c("Plains",
                                   "Midsouth",
                                   "West",
                                   "SouthCentral",
                                   "Northeast",
                                   "Southeast",
                                   "GreatLakes")
                   )
  
# Keep only the observations in the avocado dataset
# WITH matches in the major_regions
avo_regional <- avocado %>%
  semi_join(major_regions, by = "region")

# Make tibble with the names of the states / regions to NOT include
# I'm assuming that "NewYork" is the city and not the state!
states <- tibble(region = c("California",
                            "WestTexNewMexico",
                            "NorthernNewEngland",
                            "SouthCarolina")
                 )

# Keep only the observations in the avocado dataset
# WITHOUT matches in the major_regions
avo_metro <- avocado %>%
  anti_join(major_regions, by = "region") %>% 
  anti_join(states, by = "region")

```

---

# Exercises


__3.__ Which major region sold the most organic, small Hass avocados in 2017? 

```{r}
avo_regional %>% 
  filter(type == "organic", 
         year == 2017) %>%
  group_by(region) %>%
  summarize(tot_small_bags = sum(Size_Small)) %>%
  slice_max(tot_small_bags)
```

</br> 

__4.__ Use the `separate()` function to split the `Date` variable into year,
month, and day. Across all of the years, which month had the highest volume of
avocado sales?

```{r}
avocado %>%
  separate(Date, into = c("Year", "Month", "Day"),
           sep = "-") %>%
  group_by(Month) %>%
  summarize(tot_sales = sum(`Total Volume`)) %>%
  slice_max(tot_sales)
```

</br> 

__5.__ Which metro area regions sold the most total avocados?  Plot side-by-side
boxplots of total volume for only the five regions with the highest averages
for the `Total Volume` variable. 

```{r}
top5reg <- avo_metro %>%
    group_by(region) %>%
    summarize(avgtotvol = mean(`Total Volume`)) %>%
    slice_max(n = 5, avgtotvol) 

avocado %>%
  semi_join(top5reg, by = "region") %>% 
  ggplot(aes(y = region, x = `Total Volume`, fill = region)) +
  geom_boxplot() + 
  theme(legend.position = "none")

```

**Note:** I chose to use a `semi_join()` since the regions were already in a 
dataframe. You could have used the `pull()` function to extract the regions, 
and then used a `filter()` to keep only the regions `%in%` this vector of 
regions. 

</br> 

---

# Reshaping

The following four California regions are in this dataset: `"LosAngeles"`,
`"SanDiego"`, `"Sacramento"`, and `"SanFrancisco"`.  Answer the following
questions about these California regions **only**.  

```{r}
cali <- tibble(region = c("LosAngeles", 
                          "SanDiego",
                          "Sacramento", 
                          "SanFrancisco")
               )

cali_avo <- avocado %>% 
  semi_join(cali, by = "region")

```


__6.__ In which regions is the price of organic versus conventional avocados
most different?  Support your answer with a few summary statistics and a 
visualization. 

```{r}

cali_avo %>% 
  ggplot(aes(y = region, x = AveragePrice, fill = type)) + 
  geom_boxplot() +
  theme(legend.position = "top") +
  labs(y = "CA Region", 
       x = "Average Price of 1 Avocado ($)", 
       fill = "Type of Avocado")


cali_avo %>% 
  group_by(region, type) %>%
  summarize(avg_price = mean(AveragePrice)) %>%
  pivot_wider(names_from = type, 
              values_from = avg_price) %>%
  mutate(price_diff = organic - conventional)
  
```

__7.__  The following plot shows, for all four California regions, the 
proportion of the mean Hass avocado sales that are small, large,
or extra large; conventional vs. organic.  Recreate the plot.

*Hint: This will require restructuring of your data!*


```{r, include = TRUE}
cali_avo %>% 
  group_by(region, type) %>%
  summarize(across(.cols = Size_Small:Size_XL, .fns = mean)) %>%
  pivot_longer(Size_Small:Size_XL, 
               names_to = "Size", 
               values_to = "Mean_Sold") %>%
  mutate(
    Size = factor(Size, 
                  levels = c("Size_Small", "Size_Large", "Size_XL"),
                  labels = c("Small", "Large", "Extra Large"))
  ) %>%
  ggplot(aes(x = region, y = Mean_Sold, fill = Size)) +
  geom_col(position = "fill") + 
  facet_wrap(~type) + 
  scale_x_discrete(guide = guide_axis(n.dodge = 2)) + 
  labs(x = "Region of CA", 
       y = "Proportion of Mean Avocados Sold", 
       fill = "Avocado Size")

```
