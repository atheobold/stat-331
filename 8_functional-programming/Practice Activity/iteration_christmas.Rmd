---
title: "Practice Activity 8: The 12 Days of Christmas"
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: github
    css: styles.css
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = FALSE)

library(tidyverse)
```


![](christmas_tree.jpg)

## Introduction

The song "12 Days of Christmas", written around 1780, tells the tale of many
gifts a person receives in the days leading up to Christmas.
([link to lyrics](https://en.wikipedia.org/wiki/The_Twelve_Days_of_Christmas_(song)](https://en.wikipedia.org/wiki/The_Twelve_Days_of_Christmas_(song)))).  


These gifts repeat and compound; on the first day, the narrator receives

```
A partridge in a pear tree.
```

On the twelfth day, they receive

```
Twelve Drummers Drumming
Eleven Pipers Piping
Ten Lords a Leaping
Nine Ladies Waiting
Eight Maids a Milking
Seven Swans a Swimming
Six Geese a Laying
Five Golden Rings
Four Calling Birds
Three French Hens
Two Turtle Doves
And a Partridge in a Pear Tree
```

Your task will be to help write a function that automatically sings this very
repetitive song.

---

## The Repository

Go to <https://github.com/atheobold/twelvedays> to find some starter code for 
this week's practice activity. 

Fortunately, I have already created the main structure of the functions for you.
Your job is to fill in the rest of the code inside the functions. 

### Accessing the Materials -- Option 1

To get your own copy of these materials, you can **fork** it from my
account (`atheobold`). Once you have your own fork, GitHub will take you to the 
page for your copy of my `twelvedays` repository. You can then **clone** the
repository; i.e., download a copy to your local machine by copying-and-pasting 
the HTTPS address into a new RStudio project (the same steps you did in the 
skill-up session). 

Once you have a copy of the repository, you can add, commit, and push the changes you make to **your** repository. 

### Accessing the Materials -- Option 2

If you are not interested in working in GitHub for this activity, you can
download the compressed file with all of the contents for the lab. Once you
have downloaded the repository folder, double-click the `.Rproj` file inside to
launch your R Project.

## The Data

Run the code provided to load in a dataset called `xmas` that contains the crucial information about the gifts in the song. We will use this dataset to
test out our functions as we work on them.

```{r}
xmas <- read.csv("https://www.dropbox.com/s/e584pryn8evm1gz/xmas.csv?dl=1")
```

Note that your functions can - and should! - reference each other.  
That is, don't duplicate code; use earlier, smaller functions inside your
larger functions.

## Useful Packages

The packages `dplyr`, `stringr`, `glue`, and `purrr` are already loaded into
the materials for making the `twelvedays` functions. Make sure you have each of 
these packages installed! 

If you want to rely on functions from other packages that's fine, but you will 
need to load them in the set-up chunk.  

## Advice

### Workflow

Make smaller versions of the `xmas` dataset (e.g., the first two days). 

Once you feel confident in your function code, use the smaller version of the
data to test the functions you write, before you test them on the full dataset. 

### Build from small pieces

If you have some trouble getting started, I recommend writing a function that
works in one case, and then trying to generalize.

For example, in building my `sing_day()` function, I might first write a version 
called `sing_third_day()` that sings

```
On the third day of Christmas, my true love gave to me:
three french hens,
two turtle doves,
and a patridge in a pear tree.
```

#### Don't sweat the small stuff

There's a lot you can do to polish up the way the song prints.

However, the goal of this activity is to practice writing functions and using
iteration. Don't get bogged down in details like how the song displays, or small
grammar rules (like commas!), until you've finished the main tasks.

---

## Step One:  Plurals

Note that the gifts are listed in singular: for example, on day five the
narrator receives "five golden rings", but the entry in the dataset for the gift
on day five simply says "ring".  

Using the skeleton of the `pluralize_gift()` function, complete the code so that 
the function takes a gift and returns the appropriate plural. 

*Hint 1:* Note that the gifts on days six and nine have unusual pluralization.
You may assume that in other datasets, there will be no special cases besides
these types.

*Hint 2:*  The following small example may be useful to you:

```{r, eval = TRUE}
my_names <- c("Kimberly", 
              "Trini",
              "Jason",
              "Billy",
              "Zach",
              "Tommy")

my_names %>% 
  str_replace("y$", "ies")
```


**Important:**  You should **absolutely not** "hard-code" anything into this 
function; this function should work in general, not just for the items in the 12 
Days of Christmas.  For example, the word "rings" should not appear anywhere in 
the function.  I should be able to give it any gift and get back the plural of 
that gift.


### Test Your Function

Try your function out on the smaller and then larger gift dataset.  

**Consider: is your function _vectorized_?  It does not have to be, but you can
try it out if you want!**

```{r, include = FALSE}
pluralize_gift <- function(item){
  item <- case_when(
    ## Handle goose changing to geese
    str_detect(item, "oo") ~  str_replace(item, "oo", "ee"), 
    ## Handle "y" changing to "ies"
    str_detect(item, "y$") ~ str_replace(item, "y$", "ies"),
    ## Just use an "s" for everything else
    TRUE ~ str_c(item, "s")
  )
  return(item)
}
```

```{r}

# Will work if your function is vectorized! 
pluralize_gift(xmas$Gift.Item)

# Will work if your function is not vectorized!
map_chr(xmas$Gift.Item, pluralize_gift)

```

---


## Step Two: Creating sentences

Write a function called `make_phrase()` that takes as input the necessary 
information, and returns a phrase.  For example, 

```{r}
make_phrase(num = 10, 
            num_word = "ten", 
            item = "lords", 
            verb = "a-leaping", 
            adjective = "", 
            location = "")
```

should return

```
"ten lords a-leaping"
```

```{r, include = FALSE}
make_phrase <- function(num, num_word, item, verb, adjective, location) {
  
  ## Replace NAs with blank strings
  item <- replace_na(item, "")
  verb <- replace_na(verb, "")
  adjective <- replace_na(adjective, "")
  location <- replace_na(location, "")
  
  ## Figure out if a word starts with a vowel
  vowel_start <- str_sub(item, 1, 1) %>% 
    str_detect("[aeiou]")
  
  ## If the day is larger than 1, the items need pluralized! 
  item <- if_else(num > 1, pluralize_gift(item), item) 
  
  ## If the word starts with a vowel, add "an" to the beginning
  num_word <- case_when(
    num_word == 1 & vowel_start == TRUE ~ "an",
    num_word == 1 & vowel_start == FALSE ~ "a",
    TRUE ~ num_word)

  ## Glue all of the pieces together! 
  glue::glue("{num_word} {adjective} {item} {verb} {location}") %>%
    str_squish()
}
```


### Test Your Function

Try your function out on the `xmas` data, by making a new variable containing 
the daily phrases.

**Hint:** The `Day.in.Words` variable isn't quite what you want! You want `12`
to say `"twelve"` **not** `"twelfth"`. I suggest using the **english** package
to create numbered days and then use those in your `pmap_chr()`!


```{r}
xmas2 <- xmas %>%
  mutate(day.num = as.character(english::english(Day)
                                ), 
    Full.Phrase = pmap_chr(
      list(num = Day,
           num_word = day.num,
           item = Gift.Item,
           verb = Verb,
           adjective = Adjective,
           location = Location),
      make_phrase
      )
  )
```


**Your `Full.Phrase` column is the answer to this week's Practice Activity.**

**Copy and paste your `Full.Phrase` column to show me the phrases you made!**

---

## Challenge: Final Step -- Iteration

Write a function called `sing_line()` that takes as input:

* A dataset

* A number indicating which day to sing about

* The name of a column in the dataset that contains the phrases for each day.

For example,

```{r}
sing_line(xmas, 2, Full.Phrase)
```

should return

```
On the second day of Christmas, my true love sent to me:
two turtle doves and
a partridge in a pear tree.
```

*Hint:*  The `{{ phrase_col }}` part, which I provided for you, lets you use 
column names as arguments to a function.  Don't delete that line of code!

```{r, include = FALSE}
sing_line <- function(data, num, phrase_col) {
  
  ## Set up intro line
  
  num_word <- english::ordinal(num)
  
  intro <- glue::glue("On the {num_word} day of Christmas, my true love gave to me:")
  
  ## Sing gift phrases
  
  phrases <- data %>%
    pull( {{phrase_col}} )
  
  ## If the number of days is larger than 1
  ## ad an "and" to the second phrase 
  if(num > 1){
    phrases[2] <- str_c(phrases[2], " and")
  }
  
  ## Collapse all of the gifts into a single line 
  ## Start at the day and end at 1
  gift_lines <- str_c(phrases[num:1], collapse = "\n")
  
  ## Put it together
  
  return( 
    glue::glue("{intro} \n{gift_lines}")
  )
  
}
```

### A Small Test

```{r}
xmas %>% 
sing_line(num = 2, phrase_col = Full.Phrase)

```

### A Larger Test

```{r}
map_chr(1:12, ~ sing_line(xmas2, .x, Full.Phrase)) %>%
  str_c(collapse = "\n") %>%
  cat()

```

---

## Think Out Loud Recording

**What was the most difficult part of the practice activity or challenge for
you? What did you learn while struggling with this content?** 
